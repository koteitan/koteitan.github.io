<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<title>ReTern-Key Canvas版</title>
<style>
body{background:#f4f6fa;font-family:sans-serif;padding:10px}
canvas{background:#fff;border:1px solid #ccc;border-radius:8px}
#info{margin-top:8px;font-size:14px}
</style>
</head>
<body>
<canvas id="puzzle" width="800" height="200"></canvas>
<div id="info"></div>

<script>
const canvas = document.getElementById('puzzle');
const ctx = canvas.getContext('2d');
const info = document.getElementById('info');

let n = 5;                // ステージ数
let states = Array(n).fill(0);
let moves = 0;

const colors = ["#9aa0a6","#f39a3c","#2b9f5a"]; // 0,1,2

function rightAllEqual(index,value){
  for(let i=index+1;i<states.length;i++){
    if(states[i]!==value) return false;
  }
  return true;
}

function allowedTransition(i,target){
  let cur=states[i];
  if(Math.abs(target-cur)!==1) return false;
  if((cur===0&&target===1)||(cur===1&&target===0)){
    return rightAllEqual(i,2);
  }
  if((cur===1&&target===2)||(cur===2&&target===1)){
    return rightAllEqual(i,0);
  }
  return false;
}

function draw(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  let radius=40;
  let margin=30;
  let totalWidth=n*(radius*2+margin)-margin;
  let startX=(canvas.width-totalWidth)/2+radius;
  let y=canvas.height/2;
  for(let i=0;i<n;i++){
    let x=startX+i*(radius*2+margin);
    ctx.beginPath();
    ctx.arc(x,y,radius,0,Math.PI*2);
    ctx.fillStyle=colors[states[i]];
    ctx.fill();
    ctx.strokeStyle="#333";
    ctx.stroke();
    ctx.fillStyle="#fff";
    ctx.font="20px sans-serif";
    ctx.textAlign="center";
    ctx.textBaseline="middle";
    ctx.fillText(states[i],x,y);
  }
  info.textContent=`手数: ${moves}`;
}

canvas.addEventListener('click',e=>{
  let rect=canvas.getBoundingClientRect();
  let mx=e.clientX-rect.left;
  let my=e.clientY-rect.top;
  let radius=40;
  let margin=30;
  let totalWidth=n*(radius*2+margin)-margin;
  let startX=(canvas.width-totalWidth)/2+radius;
  let y=canvas.height/2;
  for(let i=0;i<n;i++){
    let x=startX+i*(radius*2+margin);
    let dx=mx-x, dy=my-y;
    if(dx*dx+dy*dy<=radius*radius){
      let cur=states[i];
      let t=cur+1;
      if(t<=2 && allowedTransition(i,t)){
        states[i]=t;
        moves++;
        draw();
      }
      break;
    }
  }
});

draw();
</script>
</body>
</html>